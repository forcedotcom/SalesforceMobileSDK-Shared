<!DOCTYPE html>
<html>
<head>
<title>Accounts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
<link rel="stylesheet" href="css/styles.css"/>
<link rel="stylesheet" href="css/ratchet.css"/>
</head>

<body>

<div id="content"></div>

<!-- Scripts -->

<!-- Local Testing -->
<!--
<script src="../../external/jquery/jquery-2.0.0.min.js"></script>
<script src="../../external/backbone/underscore-1.4.4.min.js"></script>
<script src="../../external/backbone/backbone-1.0.0.js"></script>
<script src="../../test/MockCordova.js"></script>
<script src="../../libs/forcetk.js"></script>
<script src="../../libs/cordova.force.js"></script>
<script src="../../test/MockSmartStore.js"></script>
<script src="../../libs/force.entity.js"></script>
<script src="stackrouter.js"></script>
<script src="auth_local.js"></script>
-->
<!-- End Local Testing -->

<!-- Container -->
<script src="jquery/jquery-2.0.0.min.js"></script>
<script src="backbone/underscore-1.4.4.min.js"></script>
<script src="backbone/backbone-1.0.0.min.js"></script>
<script src="cordova-2.3.0.js"></script>
<script src="forcetk.js"></script>
<script src="cordova.force.js"></script>
<script src="force.entity.js"></script>
<script src="stackrouter.js"></script>
<script src="auth.js"></script>
<!-- End Container -->


<!-- --------------------------------------- Search page template ------------------------------------------------- -->
<script id="search-page" type="text/template">
  <header class="bar-title">
    <h1 class="title">Accounts</h1>
    <a class="button" href="#add">Create</a>
  </header>
  <footer class="bar-footer">
    <span id="offlineStatus"></span>
  </footer>

  <div class="bar-standard bar-header-secondary">
    <input type="search" class="search-key" placeholder="Search"/>
  </div>

  <div class="content">
    <ul class="list"></ul>
  </div>
</script>

<!-- --------------------------------------- Online/Offline Toggler Template -------------------------------------- -->

<script id="offline-toggler" type="text/template">
  <a class="<%= isOnline ? 'button-positive' : 'button-negative' %>"><%= (isOnline ? "Online" : "Offline") %></a>
</script>

<!-- --------------------------------------- Sync Page Template --------------------------------------------------- -->

<script id="sync-page" type="text/template">
  <header class="bar-title">
    <a class="button-prev">Back</a>
    <h1 class="title">Sync</h1>
  </header>

  <footer class="bar-footer">
    <span class="button-positive">Online</span>
  </footer>

  <div class="bar-standard bar-header-secondary">
    <a class="button button-block sync">Process <%= countLocallyModified %> records</a>
  </div>

  <div class="content">
    <ul class="list"></ul>
  </div>
</script>

<!-- --------------------------------------- Account list item Template ------------------------------------------ -->
<script id="account-list-item" type="text/template">
  <a href="<%= clickAction %>">
    <div>
      <b><%= Name %></b><br/>
      <%= Id %><br/>
      <%= Industry %><br/>
      <% if (__sync_failed__) { %>
      <span class="count-negative">Failed to sync</span>
      <% } else if (__local__) { %>
      <span class="count-main">Locally<%= (__locally_created__ ? " created" : "") + (__locally_updated__ ? " updated" : "") + (__locally_deleted__ ? " deleted" : "") %></span>
      <% } %>
    </div>
  </a>
</script>

<!-- --------------------------------------- View account page template ------------------------------------------ -->
<script id="account-page" type="text/template">
  <header class="bar-title">
    <a href="#" class="button-prev">Back</a>
    <h1 class="title">Account</h1>
    <a href="#edit/accounts/<%= Id %>" class="button">Edit</a>
    <a class="button delete">Delete</a>
  </header>

  <footer class="bar-footer">
    <span id="offlineStatus"></span>
  </footer>

  <div class="content">
    <div class="content-padded">
      <% if (__local__) { %>
      <span class="count-main">Locally<%= (__locally_created__ ? " created" : "") + (__locally_updated__ ? " updated" : "") + (__locally_deleted__ ? " deleted" : "") %></span><br/><br/>
      <% } %>

      <b><%= Name %></b><br/>
      <%= Id %><br/>
      <%= Industry %><br/>
      <% if (Phone) { %> <a href="tel:<%= Phone %>"><%= Phone %></a><br/><% } %>
    </div>
  </div>
</script>

<!-- --------------------------------------- Add/edit account page template -------------------------------------- -->
<script id="edit-account-page" type="text/template">
  <header class="bar-title">
    <a href="<%= backAction %>" class="button-prev">Back</a>
    <h1 class="title"><%= action %> Account</h1>
  </header>

  <footer class="bar-footer">
    <span id="offlineStatus"></span>
  </footer>

  <div class="content">
    <div class="content-padded">

      <% if (__local__) { %>
      <span class="count-main">Locally<%= (__locally_created__ ? " created" : "") + (__locally_updated__ ? " updated" : "") + (__locally_deleted__ ? " deleted" : "") %></span><br/><br/>
      <% } %>

      <div class="input-group">
        <div class="input-row" id="accountName">
          <label>Name</label>
          <input type="text" name="Name" value="<%= Name %>" />
          <span class="error" id="accountNameError" />
        </div>
        <div class="input-row" id="accountIndustry">
          <label>Industry</label>
          <input type="text" name="Industry" value="<%= Industry %>" />
          <span class="error" id="accountIndustryError" />
        </div>
        <div class="input-row" id="accountPhone">
          <label>Phone</label>
          <input type="text" name="Phone" value="<%= Phone %>" />
          <span class="error" id="accountPhoneError" />
        </div>
      </div>
      <a class="button save">Save</a>
      <a class="button overwrite">Save (overwrite)</a>
      <a class="button merge">Save (merge changes)</a>
      <a class="button check">Save (fail if changed)</a>
      <a class="button undelete">Undelete</a>
    </div>
  </div>
</script>

<script>
// -------------------------------------------------- The Models --------------------------------------------------- //
// The Account Model
app.models.Account = Force.SObject.extend({
    sobjectType: "Account",
    fieldlist: ["Id", "Name", "Industry", "Phone"],
    cache: function() { return app.cache;},
    cacheForOriginals: function() { return app.cacheForOriginals;},
    cacheMode: function(method) {
        if (!app.offlineTracker.get("isOnline")) {
            return Force.CACHE_MODE.CACHE_ONLY;
        }
        else {
            return (method == "read" ? Force.CACHE_MODE.CACHE_FIRST : Force.CACHE_MODE.SERVER_FIRST);
        }
    }
});

// The AccountCollection Model
app.models.AccountCollection = Force.SObjectCollection.extend({
    model: app.models.Account,
    fieldlist: ["Id", "Name", "Industry", "Phone"],
    cache: function() { return app.cache},

    getCriteria: function() {
        return this.key;
    },

    setCriteria: function(key) {
        this.key = key;
    },

    config: function() {
        // Offline: do a cache query
        if (!app.offlineTracker.get("isOnline")) {
            return {type:"cache", cacheQuery:{queryType:_.isEmpty(this.key) ? "range" : "like", indexPath:"Name", likeKey: this.key+"%", order:"ascending", pageSize:25}};
        }
        // Online
        else {
            // First time: do a MRU query
            if (this.key == null) {
                return {type:"mru", sobjectType:"Account", fieldlist: this.fieldlist};
            }
            // Other times: do a SOQL query
            else {
                return {type:"soql", query:"SELECT " + this.fieldlist.join(",") + " FROM Account WHERE Name like '" + this.key + "%' ORDER BY Name LIMIT 25"};
            }
        }
    }
});

// Online/Offline Tracker
app.models.OfflineTracker = Backbone.Model.extend({
    initialize: function() {
        var that = this;
        document.addEventListener("offline", function() {
            console.log("Received OFFLINE event");
            that.set("isOnline", false);
        }, false);
        document.addEventListener("online", function() {
            console.log("Received ONLINE event");
            // User decides when to go back online
        }, false);
    }
});

// -------------------------------------------------- The Views ---------------------------------------------------- //

app.views.SearchPage = Backbone.View.extend({

    template: _.template($("#search-page").html()),

    events: {
        "keyup .search-key": "search"
    },

    initialize: function() {
        this.listView = new app.views.AccountListView({model: this.model, clickActionPrefix: "#accounts/"});
    },

    render: function(eventName) {
        $(this.el).html(this.template());
        $(".search-key", this.el).val(this.model.getCriteria());
        app.OFflineToggerView.setElement($("#offlineStatus", this.el)).render();
        this.listView.setElement($("ul", this.el)).render();
        return this;
    },

    search: function(event) {
        this.model.setCriteria($(".search-key", this.el).val());
        this.model.fetch();
    }
});

app.views.AccountListView = Backbone.View.extend({

    initialize: function() {
        this.model.bind("reset", this.render, this);
    },

    render: function(eventName) {
        $(this.el).empty();
        _.each(this.model.models, function(account) {
            var templateData = {model: account, clickActionPrefix: this.options.clickActionPrefix, backAction: this.options.backAction};
            $(this.el).append(new app.views.AccountListItemView(templateData).render().el);
        }, this);
        return this;
    }

});

app.views.AccountListItemView = Backbone.View.extend({

    tagName: "li",
    template: _.template($("#account-list-item").html()),

    render: function(eventName) {
        var templateData = _.extend({clickAction: this.options.clickActionPrefix + this.model.id, backAction: this.options.backAction, __sync_failed__:false}, this.model.toJSON());
        $(this.el).html(this.template(templateData));
        return this;
    }
});

app.views.OfflineToggler = Backbone.View.extend({

    template: _.template($("#offline-toggler").html()),

    events: {
        "click": "toggle"
    },

    initialize: function() {
        this.model.on("change:isOnline", this.render, this);
    },

    render: function(eventName) {
        $(this.el).html(this.template(this.model.toJSON()));
        return this;
    },

    toggle: function(event) {
        event.preventDefault();
        this.model.set("isOnline", !this.model.get("isOnline"))
        if (this.model.get("isOnline")) {
            app.router.navigate("#sync", {trigger:true});        
        }
    }
});

app.views.SyncPage = Backbone.View.extend({

    isSyncPage: true,

    template: _.template($("#sync-page").html()),

    events: {
        "click .button-prev": "back",
        "click .sync": "sync"
    },

    initialize: function() {
        var that = this;
        _.each(["reset","add","remove"], function(eventName) { that.model.bind(eventName, that.render, that); });
        this.listView = new app.views.AccountListView({model: this.model, clickActionPrefix: "#edit/accounts/", backAction: "#sync"});
    },

    render: function(eventName) {
        $(this.el).html(this.template(_.extend({countLocallyModified: this.model.length}, this.model.toJSON())));
        this.listView.setElement($("ul", this.el)).render();
        return this;
    },

    back: function(event) {
        if (this.model.length > 0) {
            // We are not done - going back offline before leaving screen
            app.offlineTracker.set("isOnline", false);
        }
        app.router.navigate("#", {trigger:true});
    },

    sync: function(event) {
        var that = this;
        if (this.model.length == 0 || this.model.at(0).get("__sync_failed__")) {
            // we push sync failures back to the end of the list - if we encounter one, it means we are done
            return;
        }
        else {
            var record = this.model.shift();

            var options = {
                mergeMode: Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED,
                success: function() {
                    that.sync();
                },
                error: function() {
                    record = record.set("__sync_failed__", true);
                    that.model.push(record);
                    that.sync();
                }
            };

            return record.get("__locally_deleted__") ? record.destroy(options) : record.save(null, options);
        }
    }
});

app.views.AccountPage = Backbone.View.extend({

    template: _.template($("#account-page").html()),

    events: {
        "click .delete": "delete"
    },

    render: function(eventName) {
        $(this.el).html(this.template(this.model.toJSON()));
        app.OFflineToggerView.setElement($("#offlineStatus", this.el)).render();
        return this;
    },

    delete: function(evt) {
        evt.preventDefault();
        this.model.destroy({
            success: function(data) {
                app.router.navigate("#", {trigger:true});
            },
            error: function(data, err, options) {
                var error = new Force.Error(err);
                alert("Failed to delete account: " + (error.type === "RestError" ? error.details[0].message : "Remote change detected - delete aborted"));
            }
        });
    }
});

app.views.EditAccountPage = Backbone.View.extend({

    action: null,
    backAction: null,

    template: _.template($("#edit-account-page").html()),

    events: {
        "change": "change",
        "click .save": "save",
        "click .overwrite": "save",
        "click .merge": "saveMerge",
        "click .check": "saveCheck",
        "click .undelete": "undelete"
    },

    initialize: function() {
        this.action = (null == this.model.id) ? "Add" : "Edit";
        if (this.action == "Add") { this.model.set({__local__: false, Name:"", Industry:"", Phone:"", attributes : { type: "Account"}}); }
        this.backAction = app.router.getLastPage() || "#";
        app.offlineTracker.on("change:isOnline", this.render, this);
    },

    render: function(eventName) {
        $(this.el).html(this.template(_.extend({action: this.action, backAction: this.backAction}, this.model.toJSON())));
        app.OFflineToggerView.setElement($("#offlineStatus", this.el)).render();
        if (!app.offlineTracker.get("isOnline")) { 
            $(".overwrite", this.el).hide();  
            $(".merge", this.el).hide();  
            $(".check", this.el).hide();  
        }
        else {
            $(".save", this.el).hide();
        }
        if (!this.model.get("__locally_deleted__")) {

            $(".undelete", this.el).hide();
        }
        return this;
    },

    change: function(evt) {
        // apply change to model
        var target = event.target;
        this.model.set(target.name, target.value);
        $("#account" + target.name + "Error", this.el).hide();
    },

    showFieldError: function(field, message) {
        var errorEl = $("#account" + field + "Error", this.el);
        errorEl.addClass("count-negative");
        errorEl.html(message);
        errorEl.show();
    },

    handleError: function(error) {
        var that = this;
        if (error.type === "RestError") {
            _.each(error.details, function(detail) {
                if (detail.fields == null || detail.fields.length == 0) { alert(detail.message); }
                else {_.each(detail.fields, function(field) {that.showFieldError(field, detail.message);});}
            });
        }
        else if (error.type == "ConflictError") {
            _.each(error.remoteChanges, function(field) {
                var conflict = error.conflictingChanges.indexOf(field) >=0;
                that.showFieldError(field, (conflict ? "[Conflict] " : "") + "Changed on server to: " +  error.theirs[field]);
            });
        }
    },

    getSaveOptions: function(mergeMode, cacheMode) {
        var that = this;
        return {
            cacheMode: cacheMode,
            mergeMode: mergeMode,
            success: function() { app.router.navigate(that.backAction, {trigger:true}); },
            error: function(data, err, options) { that.handleError(new Force.Error(err)); }
        };
    },

    save: function() {
        this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.OVERWRITE));
    },

    saveMerge: function() {
        this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.MERGE_ACCEPT_YOURS));
    },

    saveCheck: function() {
        this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED));
    },

    undelete: function() {
        this.model.set("__locally_deleted__", false);
        this.model.save(null, this.getSaveOptions(null, Force.CACHE_MODE.CACHE_ONLY));
    },

});


// ----------------------------------------------- The Application Router ------------------------------------------ //

app.Router = Backbone.StackRouter.extend({

    routes: {
        "": "list",
        "list": "list",
        "add": "addAccount",
        "accounts/:id": "viewAccount",
        "edit/accounts/:id": "editAccount",
        "sync":"sync"
    },

    setupCaches: function() {
        // Cache for offline support
        app.cache = new Force.StoreCache("accounts", [ {path:"Name", type:"string"} ]);

        // Cache for conflict detection 
        app.cacheForOriginals = new Force.StoreCache("original-accounts");

        return $.when(app.cache.init(), app.cacheForOriginals.init());
    },

    initialize: function() {
        Backbone.Router.prototype.initialize.call(this);

        // Setup caches
        this.setupCaches();

        // Collection behind search screen
        this.searchResults = new app.models.AccountCollection();

        // Collection behind sync screen
        this.localAccounts = new app.models.AccountCollection();
        this.localAccounts.config = {type:"cache", cacheQuery: {queryType:"exact", indexPath:"__local__", matchKey:true, order:"ascending", pageSize:25}};

        // Initializing offline tracker 
        app.offlineTracker = new app.models.OfflineTracker({isOnline: true});

        // We keep a single instance of OfflineTogger
        app.OFflineToggerView = new app.views.OfflineToggler({model: app.offlineTracker});
    },

    list: function() {
        this.searchResults.fetch();
        // Show page right away - list will redraw when data comes in
        this.slidePage(new app.views.SearchPage({model: this.searchResults})); 
    },

    addAccount: function() {
        var account = new app.models.Account({Id: null});
        this.slidePage(new app.views.EditAccountPage({model: account}));
    },

    viewAccount: function(id) {
        var that = this;
        var account = new app.models.Account({Id: id});
        account.fetch({
            success: function(data) {
                that.slidePage(new app.views.AccountPage({model: account}));
            },
            error: function() {
                alert("Failed to get record for view");
            }
        });
    },

    editAccount: function(id) {
        var that = this;
        var account = new app.models.Account({Id: id});
        account.fetch({
            success: function(data) {
                that.slidePage(new app.views.EditAccountPage({model: account}));
            },
            error: function() {
                alert("Failed to get record for edit");
            }
        });
    },

    sync: function() {
        this.localAccounts.fetch();
        // Show page right away - list will redraw when data comes in
        this.slidePage(new app.views.SyncPage({model: this.localAccounts})); 
    }
});
</script>
</body>
</html>
